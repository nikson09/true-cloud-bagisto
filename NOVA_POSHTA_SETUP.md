# Интеграция с Новой Почтой

Этот модуль добавляет интеграцию с API Новой Почты для оформления заказов в Bagisto.

## Возможности

- Автоматическая загрузка областей Украины
- Динамическая загрузка городов по выбранной области
- Загрузка отделений Новой Почты по выбранному городу
- Ограничение доставки только по Украине
- Удаление полей улицы (не требуется для доставки в отделение)

## Установка

### 1. Получение API ключа Новой Почты

1. Зарегистрируйтесь в [личном кабинете Новой Почты](https://newpost.ua/)
2. Перейдите в раздел "Настройки" → "Безопасность"
3. Сгенерируйте API ключ

### 2. Настройка конфигурации

Добавьте в ваш `.env` файл:

```env
NOVA_POSHTA_API_KEY=ваш_реальный_api_ключ_здесь
```

**Важно:** Замените `ваш_реальный_api_ключ_здесь` на ваш настоящий API ключ из личного кабинета Новой Почты.

### 3. Очистка кэша

```bash
php artisan config:clear
php artisan cache:clear
```

## Использование

После настройки в форме оформления заказа будут доступны:

1. **Выбор области** - загружается автоматически из API Новой Почты (25 областей Украины)
2. **Выбор города** - загружается после выбора области (например, 679 городов для Киевской области)
3. **Выбор отделения** - загружается после выбора города

Страна автоматически устанавливается как "Украина" (UA).

### Проверка работы API

Для проверки работы API выполните:

```bash
php artisan tinker --execute="
\$service = new App\Services\NovaPoshtaService();
\$areas = \$service->getAreas();
echo 'Areas count: ' . count(\$areas) . PHP_EOL;
"
```

Если API работает правильно, вы увидите: `Areas count: 25`

## API Endpoints

Модуль предоставляет следующие API endpoints:

- `GET /api/nova-poshta/areas` - получить список областей
- `GET /api/nova-poshta/cities?area_ref={ref}` - получить города по области
- `GET /api/nova-poshta/warehouses?city_ref={ref}` - получить отделения по городу
- `GET /api/nova-poshta/cities/search?search={query}` - поиск городов

## Структура файлов

```
app/
├── Services/
│   └── NovaPoshtaService.php          # Сервис для работы с API Новой Почты
├── Http/
│   └── Controllers/
│       └── API/
│           └── NovaPoshtaController.php # API контроллер
config/
└── services.php                       # Конфигурация API ключа
routes/
└── web.php                           # Маршруты API
packages/Webkul/Shop/src/
├── Http/
│   └── Requests/
│       └── CartAddressRequest.php    # Обновленная валидация
└── Resources/
    └── views/
        └── checkout/
            └── onepage/
                └── address/
                    └── form.blade.php # Обновленная форма адреса
```

## Кэширование

Данные из API Новой Почты кэшируются на 1 час для улучшения производительности:
- Области: `nova_poshta_areas`
- Города: `nova_poshta_cities_{area_ref}`
- Отделения: `nova_poshta_warehouses_{city_ref}`

## Обработка ошибок

Все ошибки API логируются в Laravel log файл. При недоступности API Новой Почты форма будет работать с пустыми списками.

## Требования

- PHP 8.0+
- Laravel 10+
- Bagisto 2.0+
- Активный API ключ Новой Почты
